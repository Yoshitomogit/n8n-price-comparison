{
    "name": "Integrated Mobile Ichiban & Rakuten Comparison",
    "nodes": [
        {
            "parameters": {},
            "id": "start-node",
            "name": "Start",
            "type": "n8n-nodes-base.start",
            "typeVersion": 1,
            "position": [
                240,
                300
            ]
        },
        {
            "parameters": {
                "command": "python3 /Users/miwanoyoshitomo/Documents/n8n/scrape_mobile_ichiban.py --json"
            },
            "id": "exec-python-scraper",
            "name": "Execute Mobile Ichiban Scraper",
            "type": "n8n-nodes-base.executeCommand",
            "typeVersion": 1,
            "position": [
                460,
                300
            ]
        },
        {
            "parameters": {
                "jsCode": "const mobileProducts = JSON.parse(items[0].json.stdout);\nreturn mobileProducts.map(product => ({ json: product }));"
            },
            "id": "parse-python-output",
            "name": "Parse Mobile Ichiban Data",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                680,
                300
            ]
        },
        {
            "parameters": {
                "assignments": {
                    "assignments": [
                        {
                            "id": "keyword",
                            "name": "keyword",
                            "value": "iPhone 15",
                            "type": "string"
                        },
                        {
                            "id": "applicationId",
                            "name": "applicationId",
                            "value": "1004649499121188262",
                            "type": "string"
                        }
                    ]
                }
            },
            "id": "set-params",
            "name": "ğŸ”§ æ¤œç´¢ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è¨­å®š",
            "type": "n8n-nodes-base.set",
            "typeVersion": 3.4,
            "position": [
                900,
                300
            ]
        },
        {
            "parameters": {
                "method": "GET",
                "url": "https://app.rakuten.co.jp/services/api/IchibaItem/Search/20220601",
                "sendQuery": true,
                "queryParameters": {
                    "parameters": [
                        {
                            "name": "applicationId",
                            "value": "={{ $json.applicationId }}"
                        },
                        {
                            "name": "keyword",
                            "value": "={{ $json.keyword }}"
                        },
                        {
                            "name": "hits",
                            "value": "30"
                        },
                        {
                            "name": "minPrice",
                            "value": "80000"
                        },
                        {
                            "name": "genreId",
                            "value": "560202"
                        }
                    ]
                },
                "options": {}
            },
            "id": "rakuten-api",
            "name": "ğŸ›’ æ¥½å¤©å¸‚å ´API",
            "type": "n8n-nodes-base.httpRequest",
            "typeVersion": 4.2,
            "position": [
                1120,
                300
            ]
        },
        {
            "parameters": {
                "jsCode": "// æ¥½å¤©APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‹ã‚‰å•†å“ãƒ‡ãƒ¼ã‚¿ã€JANã‚³ãƒ¼ãƒ‰ã€ãƒ–ãƒ©ãƒ³ãƒ‰ã€å‹ç•ª(MPN)ã‚’æŠ½å‡º\nconst items = $input.first().json.Items || [];\n\nconst excludeKeywords = [\n  'ã‚±ãƒ¼ã‚¹', 'ã‚«ãƒãƒ¼', 'ãƒ•ã‚£ãƒ«ãƒ ', 'ã‚¬ãƒ©ã‚¹', 'ã‚·ãƒ¼ãƒˆ',\n  'ã‚¹ãƒˆãƒ©ãƒƒãƒ—', 'ãƒ›ãƒ«ãƒ€ãƒ¼', 'ã‚¹ã‚¿ãƒ³ãƒ‰', 'ãƒãƒ¼ãƒ', 'ãƒãƒ³ãƒ‰',\n  'ã‚·ãƒ¼ãƒ«', 'ã‚¹ãƒ†ãƒƒã‚«ãƒ¼', 'ãƒªãƒ³ã‚°', 'ã‚°ãƒªãƒƒãƒ—', 'ã‚¢ã‚¯ã‚»ã‚µãƒªãƒ¼',\n  'ã‚¯ãƒ­ã‚¹', 'ã‚·ãƒ³ãƒ—ãƒ«', 'ãƒ¬ã‚¸ãƒ³', 'ãƒ‡ã‚³', 'ELECOM', 'ã‚¨ãƒ¬ã‚³ãƒ ',\n  'å……é›»å™¨', 'ã‚±ãƒ¼ãƒ–ãƒ«', 'ã‚¤ãƒ¤ãƒ›ãƒ³', 'ã‚¯ãƒªãƒ¼ãƒŠãƒ¼', '100å††', 'ãƒ‘ãƒãƒ«', 'ä¿®ç†', 'äº¤æ›', 'éƒ¨å“', 'ã‚¸ãƒ£ãƒ³ã‚¯'\n];\n\nconst results = [];\n\nif (!items.length) {\n  return [];\n}\n\nlet index = 0;\nfor (const item of items) {\n  const i = item.Item;\n  const name = i.itemName;\n  \n  if (excludeKeywords.some(kw => name.includes(kw))) continue;\n  if (name.includes('ä¸­å¤')) continue;\n  \n  // Extract Capacity for Matching\n  const capacityMatch = name.match(/(\\d+(?:GB|TB))/i);\n  const capacity = capacityMatch ? capacityMatch[1].toUpperCase() : 'UNKNOWN';\n\n  results.push({\n    json: {\n      merge_id: `rakuten_${index++}`,\n      source: 'æ¥½å¤©å¸‚å ´',\n      name: name,\n      price: i.itemPrice,\n      item_code: i.itemCode,\n      capacity: capacity,\n      url: i.itemUrl,\n      shop: i.shopName\n    }\n  });\n}\n\nreturn results;"
            },
            "id": "parse-rakuten",
            "name": "ğŸ“¦ æ¥½å¤©ãƒ‡ãƒ¼ã‚¿æ•´å½¢",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                1340,
                300
            ]
        },
        {
            "parameters": {
                "jsCode": "// ãƒ¢ãƒã‚¤ãƒ«ä¸€ç•ªãƒ‡ãƒ¼ã‚¿ã¨æ¥½å¤©ãƒ‡ãƒ¼ã‚¿ã‚’æ¯”è¼ƒ\nconst mobileItems = $('Parse Mobile Ichiban Data').all().map(i => i.json);\nconst rakutenItems = $input.all().map(i => i.json);\n\nconst results = [];\n\n// Normalize Logic\nfunction normalize(str) {\n    return str.replace(/[ï¼-ï½]/g, s => String.fromCharCode(s.charCodeAt(0) - 0xFEE0)).toLowerCase();\n}\n\nmobileItems.forEach(mobile => {\n    const mobileNameNorm = normalize(mobile.name);\n    // Simple model extraction from name\n    const baseModelParts = mobile.name\n        .replace(mobile.capacity, '')\n        .replace('simfree', '')\n        .replace('æœªé–‹å°', '')\n        .replace('é–‹å°', '')\n        .trim()\n        .toLowerCase()\n        .split(' ');\n\n    let bestMatch = null;\n    let maxProfit = -Infinity;\n\n    rakutenItems.forEach(rakuten => {\n        // Capacity Mismatch check\n        if (rakuten.capacity !== mobile.capacity) return;\n\n        const rNameNorm = normalize(rakuten.name);\n        \n        // Match model keywords\n        if (baseModelParts.every(part => rNameNorm.includes(part))) {\n            const profit = mobile.price - rakuten.price;\n            if (profit > maxProfit) {\n                maxProfit = profit;\n                bestMatch = rakuten;\n            }\n        }\n    });\n\n    if (bestMatch) {\n        results.push({\n            'å•†å“å': mobile.name,\n            'GBå®¹é‡': mobile.capacity,\n            'çŠ¶æ…‹': 'æ–°å“',\n            'ãƒ¢ãƒã‚¤ãƒ«ä¸€ç•ªè²·å–ä¾¡æ ¼': mobile.price,\n            'æ¥½å¤©è³¼å…¥ä¾¡æ ¼': bestMatch.price,\n            'è­˜åˆ¥ã‚³ãƒ¼ãƒ‰': `${mobile.code || 'N/A'}_${bestMatch.item_code}`,\n            'å·®ç›Š': maxProfit,\n            'æ¥½å¤©URL': bestMatch.url,\n            'ãƒ¢ãƒã‚¤ãƒ«ä¸€ç•ªURL': mobile.url\n        });\n    }\n});\n\n// Sort by Profit\nresults.sort((a, b) => b['å·®ç›Š'] - a['å·®ç›Š']);\n\nreturn results.map(r => ({ json: r }));"
            },
            "id": "compare-logic",
            "name": "ğŸ“Š åˆ©ç›Šæ¯”è¼ƒ",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                1560,
                300
            ]
        },
        {
            "parameters": {
                "operation": "append",
                "documentId": {
                    "__rl": true,
                    "value": "1AW1qnLR122W1UXD3fSme0jVJdcuVjocAMeuJlLkamlg",
                    "mode": "id"
                },
                "sheetName": {
                    "__rl": true,
                    "value": "JANä¾¡æ ¼æ¯”è¼ƒçµæœ",
                    "mode": "name"
                },
                "columns": {
                    "mappingMode": "autoMapInputData",
                    "value": {}
                },
                "options": {}
            },
            "id": "google-sheets",
            "name": "ğŸ“ Google Sheetså‡ºåŠ›",
            "type": "n8n-nodes-base.googleSheets",
            "typeVersion": 4.5,
            "position": [
                1780,
                300
            ]
        }
    ],
    "connections": {
        "Start": {
            "main": [
                [
                    {
                        "node": "Execute Mobile Ichiban Scraper",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Execute Mobile Ichiban Scraper": {
            "main": [
                [
                    {
                        "node": "Parse Mobile Ichiban Data",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Parse Mobile Ichiban Data": {
            "main": [
                [
                    {
                        "node": "ğŸ”§ æ¤œç´¢ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è¨­å®š",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "ğŸ”§ æ¤œç´¢ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è¨­å®š": {
            "main": [
                [
                    {
                        "node": "ğŸ›’ æ¥½å¤©å¸‚å ´API",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "ğŸ›’ æ¥½å¤©å¸‚å ´API": {
            "main": [
                [
                    {
                        "node": "ğŸ“¦ æ¥½å¤©ãƒ‡ãƒ¼ã‚¿æ•´å½¢",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "ğŸ“¦ æ¥½å¤©ãƒ‡ãƒ¼ã‚¿æ•´å½¢": {
            "main": [
                [
                    {
                        "node": "ğŸ“Š åˆ©ç›Šæ¯”è¼ƒ",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "ğŸ“Š åˆ©ç›Šæ¯”è¼ƒ": {
            "main": [
                [
                    {
                        "node": "ğŸ“ Google Sheetså‡ºåŠ›",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        }
    }
}