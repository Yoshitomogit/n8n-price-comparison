{
  "name": "æ¥½å¤©å¸‚å ´ vs ã‚¸ãƒ£ãƒ³ã±ã‚‰/ã‚¤ã‚ªã‚·ã‚¹/ãƒ¢ãƒã‚¤ãƒ«ä¸€ç•ª ä¾¡æ ¼æ¯”è¼ƒ (JANã‚³ãƒ¼ãƒ‰)",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "hours",
              "hoursInterval": 6
            }
          ]
        }
      },
      "id": "schedule-trigger",
      "name": "â° å®šæœŸå®Ÿè¡Œ (6æ™‚é–“æ¯)",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [
        0,
        0
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "keyword",
              "name": "keyword",
              "value": "iPhone 15",
              "type": "string"
            },
            {
              "id": "applicationId",
              "name": "applicationId",
              "value": "1004649499121188262",
              "type": "string"
            }
          ]
        }
      },
      "id": "set-params",
      "name": "ğŸ”§ æ¤œç´¢ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è¨­å®š",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        220,
        0
      ]
    },
    {
      "parameters": {
        "method": "GET",
        "url": "https://app.rakuten.co.jp/services/api/IchibaItem/Search/20220601",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "applicationId",
              "value": "={{ $json.applicationId }}"
            },
            {
              "name": "keyword",
              "value": "={{ $json.keyword }}"
            },
            {
              "name": "hits",
              "value": "30"
            }
          ]
        },
        "options": {}
      },
      "id": "rakuten-api",
      "name": "ğŸ›’ æ¥½å¤©å¸‚å ´API",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        440,
        0
      ]
    },
    {
      "parameters": {
        "jsCode": "// æ¥½å¤©APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‹ã‚‰å•†å“ãƒ‡ãƒ¼ã‚¿ã€JANã‚³ãƒ¼ãƒ‰ã€ãƒ–ãƒ©ãƒ³ãƒ‰ã€å‹ç•ª(MPN)ã‚’æŠ½å‡º\nconst items = $input.first().json.Items || [];\n\nconst excludeKeywords = [\n  'ã‚±ãƒ¼ã‚¹', 'ã‚«ãƒãƒ¼', 'ãƒ•ã‚£ãƒ«ãƒ ', 'ã‚¬ãƒ©ã‚¹', 'ã‚·ãƒ¼ãƒˆ',\n  'ã‚¹ãƒˆãƒ©ãƒƒãƒ—', 'ãƒ›ãƒ«ãƒ€ãƒ¼', 'ã‚¹ã‚¿ãƒ³ãƒ‰', 'ãƒãƒ¼ãƒ', 'ãƒãƒ³ãƒ‰',\n  'ã‚·ãƒ¼ãƒ«', 'ã‚¹ãƒ†ãƒƒã‚«ãƒ¼', 'ãƒªãƒ³ã‚°', 'ã‚°ãƒªãƒƒãƒ—', 'ã‚¢ã‚¯ã‚»ã‚µãƒªãƒ¼',\n  'ã‚¯ãƒ­ã‚¹', 'ã‚·ãƒ³ãƒ—ãƒ«', 'ãƒ¬ã‚¸ãƒ³', 'ãƒ‡ã‚³', 'ELECOM', 'ã‚¨ãƒ¬ã‚³ãƒ ',\n  'å……é›»å™¨', 'ã‚±ãƒ¼ãƒ–ãƒ«', 'ã‚¤ãƒ¤ãƒ›ãƒ³', 'ã‚¯ãƒªãƒ¼ãƒŠãƒ¼', '100å††'\n];\n\n// ä¸»è¦ãƒ–ãƒ©ãƒ³ãƒ‰ãƒªã‚¹ãƒˆï¼ˆæ‹¡å¼µå¯èƒ½ï¼‰\nconst majorBrands = [\n  'Apple', 'Sony', 'Panasonic', 'Canon', 'Nikon', 'Olympus', 'Fujifilm',\n  'Sharp', 'Toshiba', 'Hitachi', 'Samsung', 'LG', 'Dyson', 'Bose',\n  'Nintendo', 'PlayStation', 'Microsoft', 'Google', 'Amazon',\n  'Yamaha', 'Denon', 'Onkyo', 'JVC', 'Kenwood', 'Pioneer',\n  'Asus', 'Acer', 'Lenovo', 'HP', 'Dell', 'Epson', 'Brother'\n];\n\nconst results = [];\nconst janRegex = /(45\\d{11}|49\\d{11})/;\nconst normalizeText = (value) => (value || '').toString().replace(/[-â€•ãƒ¼\\s]/g, '');\n\nif (!items.length) {\n  return [{ json: { message: 'æ¥½å¤©APIã®ItemsãŒç©ºã§ã™', debug_keys: Object.keys($input.first().json || {}) } }];\n}\n\nlet index = 0;\nfor (const item of items) {\n  const i = item.Item;\n  const name = i.itemName;\n  const caption = i.itemCaption || '';\n  \n  if (excludeKeywords.some(kw => name.includes(kw))) continue;\n  \n  // 1. JANã‚³ãƒ¼ãƒ‰æŠ½å‡º\n  const janCandidates = [\n    i.janCode,\n    i.jan,\n    i.itemNumber,\n    i.productId,\n    name + ' ' + caption\n  ].map(normalizeText).filter(Boolean);\n  let jan = null;\n  for (const candidate of janCandidates) {\n    const janMatch = candidate.match(janRegex);\n    if (janMatch) {\n      jan = janMatch[0];\n      break;\n    }\n  }\n  \n  // 2. ãƒ–ãƒ©ãƒ³ãƒ‰åæŠ½å‡º\n  let brand = null;\n  const lowerName = name.toLowerCase();\n  for (const b of majorBrands) {\n    if (lowerName.includes(b.toLowerCase())) {\n      brand = b;\n      break;\n    }\n  }\n  \n  // 3. å‹ç•ª(MPN)æŠ½å‡º\n  let mpn = null;\n  const specificMpnMatch = (name + ' ' + caption).match(/(?:å‹ç•ª|Model|å“ç•ª)[:ï¼š\\s]*([A-Z0-9\\-]{3,})/i);\n  if (specificMpnMatch) {\n    mpn = specificMpnMatch[1];\n  } else {\n    const tokens = name.split(/[\\s\\u3000\\(\\)\\[\\]ã€Œã€ã€ã€‘]+/);\n    for (const token of tokens) {\n      if (/^[A-Z0-9\\-]{3,}$/i.test(token) && /[0-9]/.test(token) && !/^(GB|TB|MB|cm|mm|kg|Hz)$/i.test(token)) {\n        if (brand && token.toLowerCase() === brand.toLowerCase()) continue;\n        mpn = token;\n        break;\n      }\n    }\n  }\n  \n  // æ¤œç´¢ç”¨ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®æ±ºå®š (å„ªå…ˆé †ä½: JAN -> Brand+MPN -> Name)\n  let searchTerm = '';\n  let searchType = 'unknown';\n  \n  if (jan) {\n    searchTerm = jan;\n    searchType = 'JAN';\n  } else if (brand && mpn) {\n    searchTerm = `${brand} ${mpn}`;\n    searchType = 'Brand_MPN';\n  } else {\n    // å•†å“åã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚° (ã€ã€‘ã‚„[]ã§å›²ã¾ã‚ŒãŸPRæ–‡è¨€ã‚’é™¤å»)\n    let cleanName = name;\n    // å…ˆé ­ã®ãƒ–ãƒ©ã‚±ãƒƒãƒˆé™¤å»\n    cleanName = cleanName.replace(/^([ã€\\[ï¼»\\(].+?[ã€‘\\]ï¼½\\)])\\s*/, '');\n    // è¨˜å·ã‚’ã‚¹ãƒšãƒ¼ã‚¹ã«ç½®æ›\n    cleanName = cleanName.replace(/[ã€ã€‘\\[\\]ï¼»ï¼½\\(\\)\\|ï¼\\/]/g, ' ');\n    // é€£ç¶šã™ã‚‹ã‚¹ãƒšãƒ¼ã‚¹ã‚’çµ±åˆ\n    cleanName = cleanName.replace(/\\s+/g, ' ').trim();\n    // é•·ã™ãã‚‹å ´åˆã¯ã‚«ãƒƒãƒˆ (æ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³ã®è¨±å®¹ç¯„å›²ã¸)\n    searchTerm = cleanName.substring(0, 30).trim();\n    searchType = 'Name_Fallback';\n  }\n\n  // ãƒãƒ¼ã‚¸ç”¨ID (ä¸€æ„æ€§ã‚’ç¢ºä¿)\n  const mergeId = `item_${index++}_${Date.now()}`;\n\n  results.push({\n    json: {\n      merge_id: mergeId,\n      search_term: searchTerm,\n      search_type: searchType,\n      source: 'æ¥½å¤©å¸‚å ´',\n      name: name,\n      price: i.itemPrice,\n      jan: jan || 'JAN_MISSING',\n      raw_janCode: i.janCode || 'null',\n      raw_itemNumber: i.itemNumber || 'null',\n      brand: brand || 'Unknown',\n      mpn: mpn || 'Unknown',\n      url: i.itemUrl,\n      shop: i.shopName,\n      _debug_items_total: items.length,\n      _debug_results_index: results.length\n    }\n  });\n}\n\nif (results.length === 0) {\n  return [{\n    json: {\n      message: 'æœ‰åŠ¹ãªå•†å“ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ (Rakuten API returned 0 valid items)',\n      debug_item_count: items.length,\n      _debug_items_total: items.length,\n      _debug_results_count: 0\n    }\n  }];\n}\n\n// ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’æœ€åˆã®çµæœã«è¿½åŠ \nif (results.length > 0) {\n  results[0].json._debug_summary = {\n    totalItems: items.length,\n    totalResults: results.length,\n    firstSearchTerm: results[0].json.search_term,\n    firstSearchType: results[0].json.search_type,\n    firstJan: results[0].json.jan\n  };\n}\n\nreturn results;"
      },
      "id": "parse-rakuten",
      "name": "ğŸ“¦ æ¥½å¤©ãƒ‡ãƒ¼ã‚¿æ•´å½¢",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        660,
        0
      ]
    },
    {
      "parameters": {
        "jsCode": "// ä»–ã‚µã‚¤ãƒˆæ¤œç´¢ç”¨ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼\n// ã“ã“ã§Brand + MPN ã‚’ä½¿ã£ã¦eBayã‚„Google Shoppingãªã©ã‚’æ¤œç´¢ã™ã‚‹æ‹¡å¼µãŒå¯èƒ½\nreturn $input.all().map(item => {\n  const i = item.json;\n  return {\n    json: {\n      ...i,\n      search_query_brand_mpn: `${i.brand} ${i.mpn}`\n    }\n  };\n});"
      },
      "id": "prepare-multisite-search",
      "name": "ğŸ” ä»–ã‚µã‚¤ãƒˆæ¤œç´¢æº–å‚™ (Brand/MPN)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        880,
        300
      ]
    },
    {
      "parameters": {
        "method": "GET",
        "url": "https://www.janpara.co.jp/buy/search/result/",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "ORDER",
              "value": "1"
            },
            {
              "name": "S_KIND",
              "value": "0"
            },
            {
              "name": "KEYWORDS",
              "value": "={{ $json.search_term }}"
            }
          ]
        },
        "options": {
          "responseFormat": "string",
          "batching": {
            "batchSize": 1,
            "batchInterval": 3000
          }
        }
      },
      "onError": "continueErrorOutput",
      "retryOnFail": true,
      "maxTries": 3,
      "waitBetweenTries": 5000,
      "id": "janpara-http",
      "name": "ğŸ•·ï¸ ã˜ã‚ƒã‚“ã±ã‚‰å–å¾—",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        880,
        -100
      ]
    },
    {
      "parameters": {
        "method": "GET",
        "url": "https://k-tai-iosys.com/search.php",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "flag",
              "value": "fw_search"
            },
            {
              "name": "word",
              "value": "={{ $json.search_term }}"
            }
          ]
        },
        "options": {
          "responseFormat": "string",
          "batching": {
            "batchSize": 1,
            "batchInterval": 2000
          }
        }
      },
      "onError": "continueErrorOutput",
      "retryOnFail": true,
      "maxTries": 3,
      "waitBetweenTries": 4000,
      "id": "iosys-http",
      "name": "ğŸ•·ï¸ ã‚¤ã‚ªã‚·ã‚¹å–å¾—",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        880,
        100
      ]
    },
    {
      "parameters": {
        "method": "GET",
        "url": "https://www.mobile-ichiban.com/Prod/1",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "User-Agent",
              "value": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"
            }
          ]
        },
        "options": {
          "responseFormat": "string"
        }
      },
      "onError": "continueErrorOutput",
      "retryOnFail": true,
      "maxTries": 3,
      "waitBetweenTries": 4000,
      "id": "mobile-ichiban-http",
      "name": "ğŸ•·ï¸ ãƒ¢ãƒã‚¤ãƒ«ä¸€ç•ªå–å¾—",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        880,
        200
      ]
    },
    {
      "parameters": {
        "jsCode": "// ã˜ã‚ƒã‚“ã±ã‚‰ãƒ¬ã‚¹ãƒãƒ³ã‚¹è§£æ (å…¨ä»¶å‡¦ç†)\nconst allInputs = $input.all();\nreturn allInputs.map((item, index) => {\n  const input = item.json;\n  \n  // ã‚¨ãƒ©ãƒ¼ã®å ´åˆã®ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°\n  if (input.error || (!input.data && typeof input !== 'string')) {\n    // è¦ªãƒãƒ¼ãƒ‰ã‹ã‚‰merge_idã¨janã‚’å¾©å…ƒ\n    let restoreMergeId = null;\n    let restoreJan = null;\n    let restoreSearchTerm = null;\n    try {\n      const parents = $node[\"ğŸ“¦ æ¥½å¤©ãƒ‡ãƒ¼ã‚¿æ•´å½¢\"].all();\n      if (parents && parents[index]) {\n        restoreMergeId = parents[index].json.merge_id;\n        restoreJan = parents[index].json.jan;\n        restoreSearchTerm = parents[index].json.search_term;\n      }\n    } catch(e) {}\n    \n    return {\n      json: {\n        merge_id: restoreMergeId || input.merge_id || `janpara_error_${index}`,\n        jan: restoreJan || input.jan || 'UNKNOWN',\n        search_term: restoreSearchTerm || input.search_term || 'UNKNOWN',\n        error: 'Fetch Failed or Empty',\n        janpara_unused: 0,\n        janpara_used: 0,\n        _debug_janpara_error: true,\n        _debug_input_keys: Object.keys(input || {}),\n        _debug_input_type: typeof input\n      }\n    };\n  }\n\n  // HTMLãƒ‡ãƒ¼ã‚¿å–å¾—\n  const html = (typeof input === 'string') ? input : (input.data || input.body || input.response || '');\n  let mergeId = input.merge_id;\n  let jan = input.jan;\n  let searchTerm = input.search_term;\n\n  // è¦ªãƒãƒ¼ãƒ‰ã‹ã‚‰è£œå®Œ\n  if (!mergeId || !jan) {\n    try {\n      const parents = $node[\"ğŸ“¦ æ¥½å¤©ãƒ‡ãƒ¼ã‚¿æ•´å½¢\"].all();\n      if (parents && parents[index]) {\n        mergeId = mergeId || parents[index].json.merge_id;\n        jan = jan || parents[index].json.jan;\n        searchTerm = searchTerm || parents[index].json.search_term;\n      }\n    } catch(e) {}\n  }\n\n  const clean = html.replace(/\\s+/g, ' ');\n  const parsePrice = (str) => {\n    if (!str) return 0;\n    const m = str.match(/([0-9]{1,3}(?:,[0-9]{3})+)/);\n    return m ? parseInt(m[1].replace(/,/g, ''), 10) : 0;\n  };\n\n  // ã‚ˆã‚ŠæŸ”è»Ÿãªä¾¡æ ¼æŠ½å‡ºãƒ‘ã‚¿ãƒ¼ãƒ³\n  const unusedPatterns = [\n    /æœªä½¿ç”¨[\\s\\S]{0,300}?(?:price|class=[\"']price[\"'])[^>]*>([0-9,]+)/i,\n    /æœªä½¿ç”¨[\\s\\S]{0,300}?([0-9]{1,3}(?:,[0-9]{3})+)\\s*å††/i,\n    /<div[^>]*class=[\"']unused[\"'][\\s\\S]{0,300}?([0-9]{1,3}(?:,[0-9]{3})+)/i\n  ];\n  const usedPatterns = [\n    /ä¸­å¤[\\s\\S]{0,300}?(?:price|class=[\"']price[\"'])[^>]*>([0-9,]+)/i,\n    /ä¸­å¤[\\s\\S]{0,300}?([0-9]{1,3}(?:,[0-9]{3})+)\\s*å††/i,\n    /<div[^>]*class=[\"']used[\"'][\\s\\S]{0,300}?([0-9]{1,3}(?:,[0-9]{3})+)/i\n  ];\n\n  let unusedPrice = 0;\n  let usedPrice = 0;\n  for (const p of unusedPatterns) {\n    const m = clean.match(p);\n    if (m) {\n      unusedPrice = parsePrice(m[1]);\n      if (unusedPrice > 0) break;\n    }\n  }\n  for (const p of usedPatterns) {\n    const m = clean.match(p);\n    if (m) {\n      usedPrice = parsePrice(m[1]);\n      if (usedPrice > 0) break;\n    }\n  }\n\n  // fallback: ä¾¡æ ¼ä¸€è¦§ã‹ã‚‰æœ€å¤§å€¤ã‚’æ‹¾ã†\n  if (unusedPrice === 0 && usedPrice === 0) {\n    const all = [...clean.matchAll(/([0-9]{1,3}(?:,[0-9]{3})+)\\s*å††/g)]\n      .map(m => parseInt(m[1].replace(/,/g, ''), 10))\n      .filter(n => n > 0 && n < 10000000);\n    if (all.length > 0) {\n      usedPrice = Math.max(...all);\n    }\n  }\n\n  const result = {\n    json: {\n      merge_id: mergeId || `janpara_${index}`,\n      jan: jan || 'UNKNOWN',\n      search_term: searchTerm || 'UNKNOWN',\n      janpara_unused: unusedPrice,\n      janpara_used: usedPrice,\n      janpara_debug_has_html: html.length > 0,\n      janpara_debug_html_length: html.length\n    }\n  };\n  \n  // ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’æœ€åˆã®ã‚¢ã‚¤ãƒ†ãƒ ã«è¿½åŠ \n  if (index === 0) {\n    result.json._debug_janpara = {\n      inputCount: allInputs.length,\n      htmlLength: html.length,\n      mergeId: mergeId || null,\n      jan: jan || null,\n      searchTerm: searchTerm || null,\n      unusedPrice: unusedPrice,\n      usedPrice: usedPrice,\n      htmlPreview: html.substring(0, 500).replace(/\\n/g, ' ')\n    };\n  }\n  \n  return result;\n});"
      },
      "id": "parse-janpara",
      "name": "ğŸ“¦ ã˜ã‚ƒã‚“ã±ã‚‰è§£æ",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1100,
        -100
      ]
    },
    {
      "parameters": {
        "jsCode": "// ã‚¤ã‚ªã‚·ã‚¹ãƒ¬ã‚¹ãƒãƒ³ã‚¹è§£æ (å…¨ä»¶å‡¦ç†)\nconst allInputs = $input.all();\nreturn allInputs.map((item, index) => {\n  const input = item.json;\n  \n  // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°\n  if (input.error || (!input.data && typeof input !== 'string')) {\n    let restoreMergeId = null;\n    let restoreJan = null;\n    let restoreSearchTerm = null;\n    try {\n      const parents = $node[\"ğŸ“¦ æ¥½å¤©ãƒ‡ãƒ¼ã‚¿æ•´å½¢\"].all();\n      if (parents && parents[index]) {\n        restoreMergeId = parents[index].json.merge_id;\n        restoreJan = parents[index].json.jan;\n        restoreSearchTerm = parents[index].json.search_term;\n      }\n    } catch(e) {}\n    \n    return {\n      json: {\n        merge_id: restoreMergeId || input.merge_id || `iosys_error_${index}`,\n        jan: restoreJan || input.jan || 'UNKNOWN',\n        search_term: restoreSearchTerm || input.search_term || 'UNKNOWN',\n        error: 'Fetch Failed or Empty',\n        iosys_unopened: 0,\n        iosys_used_a: 0,\n        _debug_iosys_error: true,\n        _debug_input_keys: Object.keys(input || {}),\n        _debug_input_type: typeof input\n      }\n    };\n  }\n\n  // HTMLãƒ‡ãƒ¼ã‚¿å–å¾—\n  const html = (typeof input === 'string') ? input : (input.data || input.body || input.response || '');\n  let mergeId = input.merge_id;\n  let jan = input.jan;\n  let searchTerm = input.search_term;\n\n  // è¦ªãƒãƒ¼ãƒ‰ã‹ã‚‰è£œå®Œ\n  if (!mergeId || !jan) {\n    try {\n      const parents = $node[\"ğŸ“¦ æ¥½å¤©ãƒ‡ãƒ¼ã‚¿æ•´å½¢\"].all();\n      if (parents && parents[index]) {\n        mergeId = mergeId || parents[index].json.merge_id;\n        jan = jan || parents[index].json.jan;\n        searchTerm = searchTerm || parents[index].json.search_term;\n      }\n    } catch(e) {}\n  }\n\n  const clean = html.replace(/\\s+/g, ' ');\n  const parsePrice = (str) => {\n    if (!str) return 0;\n    const m = str.match(/([0-9]{1,3}(?:,[0-9]{3})+)/);\n    return m ? parseInt(m[1].replace(/,/g, ''), 10) : 0;\n  };\n\n  // ã‚ˆã‚ŠæŸ”è»Ÿãªä¾¡æ ¼æŠ½å‡ºãƒ‘ã‚¿ãƒ¼ãƒ³\n  const unopenedPatterns = [\n    /æœªä½¿ç”¨[\\s\\S]{0,300}?(?:price|class=[\"']price[\"'])[^>]*>([0-9,]+)/i,\n    /æœªä½¿ç”¨[\\s\\S]{0,300}?([0-9]{1,3}(?:,[0-9]{3})+)\\s*å††/i,\n    /æœªé–‹å°[\\s\\S]{0,300}?(?:price|class=[\"']price[\"'])[^>]*>([0-9,]+)/i\n  ];\n  const usedAPatterns = [\n    /ä¸­å¤A[\\s\\S]{0,300}?(?:price|class=[\"']price[\"'])[^>]*>([0-9,]+)/i,\n    /ä¸­å¤A[\\s\\S]{0,300}?([0-9]{1,3}(?:,[0-9]{3})+)\\s*å††/i,\n    /<td[^>]*class=[\"']price[\"'][^>]*>([0-9,]+)/i\n  ];\n\n  let unopenedPrice = 0;\n  let usedAPrice = 0;\n  for (const p of unopenedPatterns) {\n    const m = clean.match(p);\n    if (m) {\n      unopenedPrice = parsePrice(m[1]);\n      if (unopenedPrice > 0) break;\n    }\n  }\n  for (const p of usedAPatterns) {\n    const m = clean.match(p);\n    if (m) {\n      usedAPrice = parsePrice(m[1]);\n      if (usedAPrice > 0) break;\n    }\n  }\n\n  // fallback: ä¾¡æ ¼ä¸€è¦§ã‹ã‚‰æœ€å¤§å€¤ã‚’æ‹¾ã†\n  if (unopenedPrice === 0 && usedAPrice === 0) {\n    const all = [...clean.matchAll(/([0-9]{1,3}(?:,[0-9]{3})+)\\s*å††/g)]\n      .map(m => parseInt(m[1].replace(/,/g, ''), 10))\n      .filter(n => n > 0 && n < 10000000);\n    if (all.length > 0) {\n      usedAPrice = Math.max(...all);\n    }\n  }\n\n  const result = {\n    json: {\n      merge_id: mergeId || `iosys_${index}`,\n      jan: jan || 'UNKNOWN',\n      search_term: searchTerm || 'UNKNOWN',\n      iosys_unopened: unopenedPrice,\n      iosys_used_a: usedAPrice,\n      iosys_debug_has_html: html.length > 0,\n      iosys_debug_html_length: html.length\n    }\n  };\n  \n  // ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’æœ€åˆã®ã‚¢ã‚¤ãƒ†ãƒ ã«è¿½åŠ \n  if (index === 0) {\n    result.json._debug_iosys = {\n      inputCount: allInputs.length,\n      htmlLength: html.length,\n      mergeId: mergeId || null,\n      jan: jan || null,\n      searchTerm: searchTerm || null,\n      unopenedPrice: unopenedPrice,\n      usedAPrice: usedAPrice,\n      htmlPreview: html.substring(0, 500).replace(/\\n/g, ' ')\n    };\n  }\n  \n  return result;\n});"
      },
      "id": "parse-iosys",
      "name": "ğŸ“¦ ã‚¤ã‚ªã‚·ã‚¹è§£æ",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1100,
        100
      ]
    },
    {
      "parameters": {
        "jsCode": "// ãƒ¢ãƒã‚¤ãƒ«ä¸€ç•ª ãƒ¬ã‚¹ãƒãƒ³ã‚¹è§£æ (Prod/1 ã‚¹ãƒãƒ›è²·å–ãƒšãƒ¼ã‚¸)\nconst allInputs = $input.all();\nconst html = (() => {\n  const raw = allInputs[0]?.json?.data || allInputs[0]?.json?.body || allInputs[0]?.json?.response || '';\n  return typeof raw === 'string' ? raw : '';\n})();\nconst parsePrice = (s) => { const m = (s||'').match(/([0-9,]+)/); return m ? parseInt(m[1].replace(/,/g,''),10) : 0; };\nconst products = [];\n\nif (html.length > 500) {\n  const regex = /(iPhone\\s+[\\d\\s]+(?:Pro\\s+Max|Pro|Plus|e)?\\s*\\d+GB\\s+simfree\\s*(æœªé–‹å°|é–‹å°)?)[\\s\\S]{0,200}?([0-9]{2,3},[0-9]{3})\\s*å††/g;\n  let m;\n  while ((m = regex.exec(html)) !== null) {\n    const name = m[1].trim();\n    const price = parsePrice(m[3]);\n    if (price < 10000 || price > 500000) continue;\n    const hasUnopened = /æœªé–‹å°/.test(name);\n    const hasOpened = /é–‹å°/.test(name);\n    products.push({ name, unopened: hasUnopened ? price : 0, used: hasOpened ? price : 0 });\n  }\n}\n\nconst matchTerm = (name, term) => {\n  const n = (name||'').toLowerCase().replace(/\\s/g,'');\n  const t = (term||'').toString().toLowerCase().replace(/\\s/g,'');\n  if (!t || t.length < 2) return true;\n  return n.includes(t) || n.includes(t.replace(/[^a-z0-9]/g,''));\n};\n\nreturn allInputs.map((item, idx) => {\n  const input = item.json;\n  let mergeId = input.merge_id, searchTerm = input.search_term;\n  try {\n    const parents = $node[\"ğŸ“¦ æ¥½å¤©ãƒ‡ãƒ¼ã‚¿æ•´å½¢\"]?.all();\n    if (parents?.[idx]) {\n      mergeId = mergeId || parents[idx].json.merge_id;\n      searchTerm = searchTerm || parents[idx].json.search_term;\n    }\n  } catch(e){}\n  let unopened = 0, used = 0;\n  for (const p of products) {\n    if (!matchTerm(p.name, searchTerm)) continue;\n    if (p.unopened > unopened) unopened = p.unopened;\n    if (p.used > used) used = p.used;\n  }\n  if (unopened === 0 && used === 0 && products.length > 0) {\n    const fallback = products.find(p => matchTerm(p.name, 'iPhone'));\n    if (fallback) { unopened = fallback.unopened; used = fallback.used; }\n  }\n  return { json: { merge_id: mergeId || `mobile_${idx}`, mobile_ichiban_unopened: unopened, mobile_ichiban_used: used } };\n});"
      },
      "id": "parse-mobile-ichiban",
      "name": "ğŸ“¦ ãƒ¢ãƒã‚¤ãƒ«ä¸€ç•ªè§£æ",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1100,
        200
      ]
    },
    {
      "parameters": {
        "mode": "combine",
        "combinationMode": "mergeByKey",
        "propertyNameMatches": "merge_id"
      },
      "id": "merge-results",
      "name": "ğŸ”„ ãƒ‡ãƒ¼ã‚¿çµ±åˆ (ä¿®æ­£å®Œäº†)",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3,
      "position": [
        1320,
        0
      ]
    },
    {
      "parameters": {
        "jsCode": "// æœ€çµ‚åˆ©ç›Šè¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆå…¨ä»¶å‡ºåŠ›ãƒ¢ãƒ¼ãƒ‰ï¼‰\nconst items = $input.all();\nconst results = [];\nconst threshold = 1000;\n\nfor (const item of items) {\n  const rakuten = item.json;\n  \n  // æœªä½¿ç”¨ãƒ»æœªé–‹å°ä¾¡æ ¼ã‚’å„ªå…ˆã€ãªã‘ã‚Œã°ä¸­å¤ä¾¡æ ¼\n  const buyPrices = [\n    rakuten.janpara_unused,\n    rakuten.iosys_unopened,\n    rakuten.mobile_ichiban_unopened,\n    rakuten.janpara_used,\n    rakuten.iosys_used_a,\n    rakuten.mobile_ichiban_used\n  ].filter(p => p > 0 && typeof p === 'number');\n  \n  // è²·å–ä¾¡æ ¼ãŒè¦‹ã¤ã‹ã‚Œã°è¨ˆç®—ã€ãªã‘ã‚Œã°0\n  const maxBuyPrice = buyPrices.length > 0 ? Math.max(...buyPrices) : 0;\n  const profit = maxBuyPrice - rakuten.price;\n  \n  // åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯\n  let status = 'åˆ¤å®šä¸èƒ½';\n  if (maxBuyPrice === 0) {\n    status = 'è²·å–ä¾¡æ ¼ãªã—';\n  } else if (profit >= threshold) {\n    status = 'åˆ©ç›Šã‚ã‚Š';\n  } else {\n    status = 'åˆ©ç›Šä¸è¶³';\n  }\n\n  results.push({\n    json: {\n      æ¯”è¼ƒæ—¥æ™‚: new Date().toISOString(),\n      å•†å“å: rakuten.name,\n      JANã‚³ãƒ¼ãƒ‰: rakuten.jan,\n      ãƒ–ãƒ©ãƒ³ãƒ‰: rakuten.brand || '-',\n      å‹ç•ª: rakuten.mpn || '-',\n      æ¥½å¤©ä¾¡æ ¼: rakuten.price,\n      æœ€é«˜è²·å–ä¾¡æ ¼: maxBuyPrice,\n      å·®ç›Š: profit,\n      åˆ¤å®š: status,\n      ã‚¸ãƒ£ãƒ³ã±ã‚‰æœªä½¿ç”¨: rakuten.janpara_unused || 0,\n      ã‚¤ã‚ªã‚·ã‚¹æœªé–‹å°: rakuten.iosys_unopened || 0,\n      ãƒ¢ãƒã‚¤ãƒ«ä¸€ç•ªæœªé–‹å°: rakuten.mobile_ichiban_unopened || 0,\n      ãƒ¢ãƒã‚¤ãƒ«ä¸€ç•ªä¸­å¤: rakuten.mobile_ichiban_used || 0,\n      æ¥½å¤©URL: rakuten.url\n    }\n  });\n}\n\n// çµæœãŒç©ºã®å ´åˆã®ãƒ‡ãƒãƒƒã‚°å‡ºåŠ›\nif (results.length === 0) {\n    return [{ json: { message: 'å‡¦ç†å¯¾è±¡ã®å•†å“ãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸ', debug_items_merged: items.length } }];\n}\n\nreturn results;"
      },
      "id": "compare-logic",
      "name": "ğŸ“Š åˆ©ç›Šæ¯”è¼ƒ (1000å††ä½ä¸Š)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1540,
        0
      ]
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": {
          "__rl": true,
          "value": "1AW1qnLR122W1UXD3fSme0jVJdcuVjocAMeuJlLkamlg",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "value": "JANä¾¡æ ¼æ¯”è¼ƒçµæœ",
          "mode": "name"
        },
        "columns": {
          "mappingMode": "autoMapInputData",
          "value": {}
        },
        "options": {}
      },
      "id": "google-sheets",
      "name": "ğŸ“ Google Sheetså‡ºåŠ›",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        1760,
        0
      ]
    }
  ],
  "connections": {
    "â° å®šæœŸå®Ÿè¡Œ (6æ™‚é–“æ¯)": {
      "main": [
        [
          {
            "node": "ğŸ”§ æ¤œç´¢ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è¨­å®š",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ”§ æ¤œç´¢ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è¨­å®š": {
      "main": [
        [
          {
            "node": "ğŸ›’ æ¥½å¤©å¸‚å ´API",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ›’ æ¥½å¤©å¸‚å ´API": {
      "main": [
        [
          {
            "node": "ğŸ“¦ æ¥½å¤©ãƒ‡ãƒ¼ã‚¿æ•´å½¢",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“¦ æ¥½å¤©ãƒ‡ãƒ¼ã‚¿æ•´å½¢": {
      "main": [
        [
          {
            "node": "ğŸ•·ï¸ ã˜ã‚ƒã‚“ã±ã‚‰å–å¾—",
            "type": "main",
            "index": 0
          },
          {
            "node": "ğŸ•·ï¸ ã‚¤ã‚ªã‚·ã‚¹å–å¾—",
            "type": "main",
            "index": 0
          },
          {
            "node": "ğŸ” ä»–ã‚µã‚¤ãƒˆæ¤œç´¢æº–å‚™ (Brand/MPN)",
            "type": "main",
            "index": 0
          },
          {
            "node": "ğŸ”„ ãƒ‡ãƒ¼ã‚¿çµ±åˆ",
            "type": "main",
            "index": 0
          },
          {
            "node": "ğŸ•·ï¸ ãƒ¢ãƒã‚¤ãƒ«ä¸€ç•ªå–å¾—",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ•·ï¸ ã˜ã‚ƒã‚“ã±ã‚‰å–å¾—": {
      "main": [
        [
          {
            "node": "ğŸ“¦ ã˜ã‚ƒã‚“ã±ã‚‰è§£æ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ•·ï¸ ã‚¤ã‚ªã‚·ã‚¹å–å¾—": {
      "main": [
        [
          {
            "node": "ğŸ“¦ ã‚¤ã‚ªã‚·ã‚¹è§£æ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ•·ï¸ ãƒ¢ãƒã‚¤ãƒ«ä¸€ç•ªå–å¾—": {
      "main": [
        [
          {
            "node": "ğŸ“¦ ãƒ¢ãƒã‚¤ãƒ«ä¸€ç•ªè§£æ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“¦ ã˜ã‚ƒã‚“ã±ã‚‰è§£æ": {
      "main": [
        [
          {
            "node": "ğŸ”„ ãƒ‡ãƒ¼ã‚¿çµ±åˆ",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "ğŸ“¦ ã‚¤ã‚ªã‚·ã‚¹è§£æ": {
      "main": [
        [
          {
            "node": "ğŸ”„ ãƒ‡ãƒ¼ã‚¿çµ±åˆ",
            "type": "main",
            "index": 2
          }
        ]
      ]
    },
    "ğŸ“¦ ãƒ¢ãƒã‚¤ãƒ«ä¸€ç•ªè§£æ": {
      "main": [
        [
          {
            "node": "ğŸ”„ ãƒ‡ãƒ¼ã‚¿çµ±åˆ",
            "type": "main",
            "index": 3
          }
        ]
      ]
    },
    "ğŸ”„ ãƒ‡ãƒ¼ã‚¿çµ±åˆ": {
      "main": [
        [
          {
            "node": "ğŸ“Š åˆ©ç›Šæ¯”è¼ƒ (1000å††ä½ä¸Š)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“Š åˆ©ç›Šæ¯”è¼ƒ (1000å††ä½ä¸Š)": {
      "main": [
        [
          {
            "node": "ğŸ“ Google Sheetså‡ºåŠ›",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [],
  "triggerCount": 0,
  "updatedAt": "2026-01-26T00:00:00.000Z",
  "versionId": "1"
}
